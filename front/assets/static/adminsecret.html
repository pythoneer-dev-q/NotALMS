<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>notalms — admin</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600&display=swap" rel="stylesheet">
<link rel="icon" href="/favicon.ico" sizes="32x32">
<style>
:root{
  --bg:#0f172a;--panel:rgba(20,40,70,.95);--text:#e2e8f0;--accent:#4ade80;--primary:#6366f1;--loader-color:#8603D3;
}
*{box-sizing:border-box}
body{margin:0;font-family:Oswald, sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.header{height:60px;display:flex;align-items:center;padding:0 20px;background:var(--panel);border-bottom:1px solid rgba(99,102,241,.15)}
.logo{color:var(--primary);font-size:1.2rem}
.container{display:flex;gap:20px;padding:20px}
.column{background:rgba(15,23,42,.6);border:1px solid rgba(99,102,241,.06);padding:16px;border-radius:8px;flex:1;min-width:320px}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.input,textarea,select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--text);outline:none}
textarea{min-height:80px;resize:vertical}
.btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:6px;cursor:pointer}
.small{font-size:0.85rem;color:#a8b1c8;margin-bottom:8px}
.row{display:flex;gap:8px}
.col-2{flex:1}
.notice{background:rgba(255,255,255,.02);padding:8px;border-radius:6px;margin-bottom:8px;color:#9aa3bf;font-size:.9rem}

/* loader */
.loading-screen{position:fixed;inset:0;background:rgba(5,5,15,.85);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:.12s}
.loading-screen.visible{opacity:1;pointer-events:auto}
.loader-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
.notalms-loader{width:64px;height:64px;filter:drop-shadow(0 0 18px rgba(134,3,211,.6))}
.loading-text{color:var(--loader-color);font-size:13px}
.footer{padding:12px;text-align:center;color:#8f9ab1;font-size:13px}
.block-title{font-weight:600;color:var(--primary);margin-bottom:8px}
.list-inline{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.tag{background:rgba(255,255,255,.03);padding:6px 8px;border-radius:6px;font-size:.85rem}
.small-muted{font-size:.82rem;color:#9aa3bf}

/* content builder */
.builder{border:1px dashed rgba(255,255,255,.04);padding:8px;border-radius:6px;margin-bottom:8px}
.block{background:rgba(255,255,255,.02);padding:8px;border-radius:6px;margin-bottom:8px;display:flex;gap:8px;align-items:flex-start}
.block textarea{min-height:36px}
.block .controls{min-width:120px}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.04);color:var(--text);padding:6px;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<header class="header"><div class="logo">notalms — admin</div></header>

<div class="container">
  <div class="column" id="auth-column">
    <div class="block-title">админ-доступ</div>
    <div class="small">введите секретный пароль для доступа к панели</div>
    <div style="margin-top:12px" class="form-row">
      <input id="admin-pass" class="input" placeholder="пароль" type="password" />
      <button id="btn-login" class="btn">войти</button>
    </div>
    <div id="auth-msg" class="small-muted" style="margin-top:8px"></div>

    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,.03)">

    <div class="small-muted">смена пароля / выход</div>
    <div style="margin-top:8px" class="row">
      <button id="btn-logout" class="btn btn-ghost" style="background:transparent;border:1px solid rgba(255,255,255,.04)">выйти</button>
      <div style="flex:1"></div>
    </div>
  </div>

  <div class="column" id="course-column" style="display:none">
    <div class="block-title">создать курс</div>
    <div class="small-muted">заполните поля. поля lessons / granted_to / tags — через запятую</div>
    <div class="form-row"><input id="course-id" class="input" placeholder="id курса (например dna_basic)"></div>
    <div class="form-row"><input id="course-title" class="input" placeholder="заголовок курса"></div>
    <div class="form-row"><input id="course-order" class="input" placeholder="порядок (число)"></div>
    <div class="form-row"><input id="course-lessons" class="input" placeholder="lessons (id1,id2,...)"></div>
    <div class="form-row"><input id="course-granted" class="input" placeholder="granted_to (all,group1,...)"></div>
    <div class="form-row"><input id="course-tags" class="input" placeholder="tags (bio,dna,...)"></div>
    <div class="form-row"><input id="course-cover" class="input" placeholder="cover url (опционально)"></div>
    <div class="form-row"><textarea id="course-desc" class="input" placeholder="описание"></textarea></div>
    <div class="row" style="margin-bottom:8px">
      <select id="course-diff" class="input col-2"><option value="easy">easy</option><option value="hard">hard</option></select>
      <label style="display:flex;align-items:center;gap:8px"><input id="course-pub" type="checkbox" checked> опубликовать</label>
    </div>
    <div class="row">
      <button id="btn-create-course" class="btn">создать курс</button>
      <div id="course-res" class="small-muted" style="padding-left:8px"></div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,.03)">

    <div class="block-title">создать урок</div>
    <div class="small-muted">создайте блоки контента (text, image, list, code, warning)</div>

    <div style="margin-top:8px" class="form-row">
      <input id="lesson-id" class="input" placeholder="id урока">
      <input id="lesson-course" class="input" placeholder="course_id">
    </div>
    <div class="form-row"><input id="lesson-title" class="input" placeholder="заголовок"></div>
    <div class="row" style="margin-bottom:8px">
      <select id="lesson-type" class="input col-2"><option value="theory">theory</option><option value="test">test</option></select>
      <input id="lesson-order" class="input" placeholder="order (число)">
    </div>

    <div class="builder" id="content-builder">
      <div class="small-muted">контент-структура</div>
      <div id="blocks"></div>
      <div style="margin-top:8px" class="row">
        <select id="new-block-type" class="input col-2">
          <option value="text">text</option>
          <option value="image">image</option>
          <option value="list">list</option>
          <option value="code">code</option>
          <option value="warning">warning</option>
        </select>
        <button id="btn-add-block" class="btn btn-ghost">добавить блок</button>
      </div>
    </div>

    <div class="row">
      <button id="btn-create-lesson" class="btn">создать урок</button>
      <div id="lesson-res" class="small-muted" style="padding-left:8px"></div>
    </div>
  </div>

  <div class="column" id="task-column" style="display:none">
    <div class="block-title">создать задание (task)</div>
    <div class="small-muted">id, lesson_id, mode (эндпоинт проверки), settings - json</div>
    <div class="form-row"><input id="task-id" class="input" placeholder="id задания"></div>
    <div class="form-row"><input id="task-lesson" class="input" placeholder="lesson_id"></div>
    <div class="form-row"><input id="task-mode" class="input" placeholder="mode (например dna)"></div>
    <div class="form-row"><input id="task-type" class="input" placeholder="type (optional)"></div>
    <div class="form-row"><select id="task-diff" class="input"><option value="easy">easy</option><option value="hard">hard</option></select></div>
    <div class="form-row"><textarea id="task-settings" class="input" placeholder='settings json, например {"len":5}'></textarea></div>
    <div class="row">
      <button id="btn-create-task" class="btn">создать задачу</button>
      <div id="task-res" class="small-muted" style="padding-left:8px"></div>
    </div>
  </div>
</div>

<!-- глобальный лоадер с твоим svg -->
<div id="loading" class="loading-screen" aria-hidden="true">
  <div class="loader-wrap" role="status" aria-live="polite">
    <svg class="notalms-loader" fill="#8603D3FF" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z" opacity=".25"/>
      <path d="M10.72,19.9a8,8,0,0,1-6.5-9.79A7.77,7.77,0,0,1,10.4,4.16a8,8,0,0,1,9.49,6.52A1.54,1.54,0,0,0,21.38,12h.13a1.37,1.37,0,0,0,1.38-1.54,11,11,0,1,0-12.7,12.39A1.54,1.54,0,0,0,12,21.34h0A1.47,1.47,0,0,0,10.72,19.9Z">
        <animateTransform attributeName="transform" type="rotate" dur="0.75s" values="0 12 12;360 12 12" repeatCount="indefinite"/>
      </path>
    </svg>
    <div class="loading-text">загрузка...</div>
  </div>
</div>

<div class="footer">admin panel minimal — сохраняй изменения через api</div>

<script>
/* минималка, все комментарии строчными буквами */
const API_BASE = 'https://lmsapi.cloudpub.ru/v1'; // заменить на реальный базовый путь если нужно
const adminKeyName = 'notalms_admin_secret';

// простой loader manager
const loader = {
  el: document.getElementById('loading'),
  cnt: 0,
  enter(){ this.cnt++; if(this.cnt>0) this.el.classList.add('visible') },
  leave(){ this.cnt = Math.max(0,this.cnt-1); if(this.cnt===0) this.el.classList.remove('visible') }
};

// auth helpers
function setSecret(s){ sessionStorage.setItem(adminKeyName, s); }
function getSecret(){ return sessionStorage.getItem(adminKeyName); }
function clearSecret(){ sessionStorage.removeItem(adminKeyName); }

// api wrapper
async function apiPost(path, body){
  const secret = getSecret();
  if(!secret) throw new Error('no-secret');
  loader.enter();
  try{
    const res = await fetch(API_BASE + path, {
      method: 'POST',
      headers: {
        'content-type':'application/json',
        'x-admin-secret': secret
      },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=>({error:'invalid json'}));
    if(!res.ok) return {error: data?.detail || data?.error || 'http error'};
    return data;
  }catch(e){
    return {error: e.message || 'network error'};
  }finally{ loader.leave(); }
}

// ui helpers
function showColumns(show){
  document.getElementById('course-column').style.display = show ? 'block' : 'none';
  document.getElementById('task-column').style.display = show ? 'block' : 'none';
  document.getElementById('auth-column').style.display = show ? 'none' : 'block';
}
function setMsg(selector, text){ const el = document.getElementById(selector); if(el) el.textContent = text; }

// auth flow
document.getElementById('btn-login').onclick = async ()=>{
  const pass = document.getElementById('admin-pass').value.trim();
  if(!pass){ setMsg('auth-msg','введите пароль'); return;}
  // пробная проверка: отправим пустой пост для проверки секрета
  setMsg('auth-msg','проверка...');
  sessionStorage.setItem(adminKeyName, pass);
  // делаем тест-запрос, если api поддерживает проверку, иначе просто показываем панель
  try{
    loader.enter();
    const res = await fetch(API_BASE + '/ping', { method:'GET', headers: {'x-admin-secret': pass} }).catch(()=>null);
    loader.leave();
    if(res && res.ok){
      setMsg('auth-msg','доступ подтверждён');
      setTimeout(()=> setMsg('auth-msg',''), 1500);
      initAfterAuth();
      return;
    }
  }catch(e){ /* ignore */ }
  // если нет ping или не прошёл - все равно показываем панель (сервер может не иметь ping)
  setMsg('auth-msg','вход выполнен (локально)');
  initAfterAuth();
};

document.getElementById('btn-logout').onclick = ()=>{
  clearSecret();
  showColumns(false);
  setMsg('auth-msg','вышли из панели');
};

// инициализация после авторизации
function initAfterAuth(){
  showColumns(true);
  bindCourseButtons();
  bindLessonBuilder();
  bindTaskButtons();
  loadCoursesSelect(); // пополнить селекты если нужно
}

// create course
function parseCsv(s){ return s.split(',').map(x=>x.trim()).filter(Boolean); }

function bindCourseButtons(){
  document.getElementById('btn-create-course').onclick = async ()=>{
    const body = {
      id: document.getElementById('course-id').value.trim(),
      title: document.getElementById('course-title').value.trim(),
      lessons: parseCsv(document.getElementById('course-lessons').value || ''),
      granted_to: parseCsv(document.getElementById('course-granted').value || ''),
      tags: parseCsv(document.getElementById('course-tags').value || ''),
      order: parseInt(document.getElementById('course-order').value || '-1',10),
      cover: document.getElementById('course-cover').value || undefined,
      description: document.getElementById('course-desc').value || '',
      difficulty: document.getElementById('course-diff').value || 'easy',
      is_published: document.getElementById('course-pub').checked
    };
    setMsg('course-res','создание...');
    const r = await apiPost('/createCourse', {
      id: body.id, title: body.title, lessons: body.lessons, granted_to: body.granted_to,
      tags: body.tags, order: body.order, cover: body.cover, description: body.description,
      difficulty: body.difficulty, is_published: body.is_published
    });
    if(r && !r.error){ setMsg('course-res','ok'); loadCoursesSelect(); } else { setMsg('course-res','err: '+(r.error||'unknown'));}
  };
}

// lesson content builder
function bindLessonBuilder(){
  document.getElementById('btn-add-block').onclick = (e)=>{
    e.preventDefault();
    const t = document.getElementById('new-block-type').value;
    addBlock(t);
  };
  document.getElementById('btn-create-lesson').onclick = async ()=>{
    const id = document.getElementById('lesson-id').value.trim();
    const course_id = document.getElementById('lesson-course').value.trim();
    const title = document.getElementById('lesson-title').value.trim();
    const type_lesson = document.getElementById('lesson-type').value;
    const order = parseInt(document.getElementById('lesson-order').value||'-1',10);
    const content = readBlocks();
    setMsg('lesson-res','создание...');
    const r = await apiPost('/createLesson', { id, course_id, title, type: type_lesson, order, content });
    if(r && !r.error){ setMsg('lesson-res','ok'); loadCoursesSelect(); } else { setMsg('lesson-res','err: '+(r.error||'unknown'));}
  };
}

// builder helpers
function addBlock(type, data){
  const id = 'block-'+Math.random().toString(36).slice(2,9);
  const blocks = document.getElementById('blocks');
  const div = document.createElement('div'); div.className='block'; div.id = id;
  const controls = document.createElement('div'); controls.className='controls';
  controls.innerHTML = `<div class="small-muted" style="font-size:.85rem;margin-bottom:6px">${type}</div>
    <button class="btn-ghost" data-action="up">up</button>
    <button class="btn-ghost" data-action="down">down</button>
    <button class="btn-ghost" data-action="remove">del</button>`;
  const body = document.createElement('div'); body.style.flex='1';
  if(type === 'text' || type === 'warning' || type === 'code'){
    const ta = document.createElement('textarea'); ta.className='input'; ta.placeholder = type; ta.value = data?.value || '';
    body.appendChild(ta);
  } else if(type === 'image'){
    const inp = document.createElement('input'); inp.className='input'; inp.placeholder='url'; inp.value = data?.src || '';
    const alt = document.createElement('input'); alt.className='input'; alt.placeholder='alt'; alt.value = data?.alt || '';
    body.appendChild(inp); body.appendChild(alt);
  } else if(type === 'list'){
    const ul = document.createElement('div'); ul.style.marginBottom='6px';
    const addLi = document.createElement('button'); addLi.className='btn btn-ghost'; addLi.textContent='add item';
    const itemsWrap = document.createElement('div');
    (data?.items||[]).forEach(it=>{
      const itEl = document.createElement('div'); itEl.style.display='flex'; itEl.style.gap='6px'; itEl.style.marginBottom='6px';
      const inp = document.createElement('input'); inp.className='input'; inp.value = it; itEl.appendChild(inp);
      const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='x'; del.onclick = ()=> itEl.remove();
      itEl.appendChild(del); itemsWrap.appendChild(itEl);
    });
    addLi.onclick = ()=> {
      const itEl = document.createElement('div'); itEl.style.display='flex'; itEl.style.gap='6px'; itEl.style.marginBottom='6px';
      const inp = document.createElement('input'); inp.className='input'; itEl.appendChild(inp);
      const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='x'; del.onclick = ()=> itEl.remove();
      itEl.appendChild(del); itemsWrap.appendChild(itEl);
    };
    body.appendChild(itemsWrap); body.appendChild(addLi);
  }
  div.appendChild(controls); div.appendChild(body);
  blocks.appendChild(div);

  // controls events
  controls.querySelectorAll('button').forEach(b=>{
    b.onclick = (ev)=>{
      const action = b.getAttribute('data-action');
      if(action === 'remove'){ div.remove(); }
      if(action === 'up'){ const prev = div.previousElementSibling; if(prev) div.parentNode.insertBefore(div, prev); }
      if(action === 'down'){ const next = div.nextElementSibling; if(next) div.parentNode.insertBefore(next, div.nextSibling.nextSibling); }
    };
  });
}

function readBlocks(){
  const out = [];
  const nodes = Array.from(document.getElementById('blocks').children);
  for(const n of nodes){
    const t = n.querySelector('.small-muted')?.textContent || 'text';
    if(t === 'text' || t === 'warning' || t === 'code'){
      const v = n.querySelector('textarea')?.value || '';
      out.push({type: t, value: v});
    } else if(t === 'image'){
      const inputs = n.querySelectorAll('input');
      out.push({type: 'image', src: inputs[0]?.value || '', alt: inputs[1]?.value || ''});
    } else if(t === 'list'){
      const items = Array.from(n.querySelectorAll('input')).map(ii=>ii.value).filter(Boolean);
      out.push({type:'list', items});
    } else {
      // fallback
      const txt = n.querySelector('textarea')?.value || (n.querySelector('input')?.value) || '';
      out.push({type:'text', value:txt});
    }
  }
  return out;
}

// task
function bindTaskButtons(){
  document.getElementById('btn-create-task').onclick = async ()=>{
    const id = document.getElementById('task-id').value.trim();
    const lesson_id = document.getElementById('task-lesson').value.trim();
    const mode = document.getElementById('task-mode').value.trim();
    const type_task = document.getElementById('task-type').value.trim();
    const difficulty = document.getElementById('task-diff').value;
    let settings = {};
    try{ settings = JSON.parse(document.getElementById('task-settings').value || '{}'); }catch(e){ setMsg('task-res','invalid json'); return; }
    setMsg('task-res','создание...');
    const r = await apiPost('/createTask', { id, lesson_id, mode, settings, type_task, difficulty });
    if(r && !r.error){ setMsg('task-res','ok'); } else { setMsg('task-res','err: '+(r.error||'unknown'));}
  };
}

// utility: загрузить курсы в селекты (если нужно)
async function loadCoursesSelect(){
  try{
    // пример получения курсов (админ роль можно заменить)
    loader.enter();
    const res = await fetch(API_BASE + '/search_courses/admin', { headers: {'x-admin-secret': getSecret() } }).catch(()=>null);
    loader.leave();
    if(!res || !res.ok) return;
    const list = await res.json().catch(()=>[]);
    // вставим в lesson-course поле подсказку
    const sel = document.getElementById('lesson-course');
    if(sel && list && Array.isArray(list)){
      // если поле обычный input - не трогаем. можно сделать datalist, но минимально - автодоп
    }
  }catch(e){}
}

// если уже есть секрет - показываем панель сразу
if(getSecret()){ initAfterAuth(); }
</script>
</body>
</html>
